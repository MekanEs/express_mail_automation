# Задача: Реализовать JSON-отчетность для процесса обработки почты\n\n## Цель\n\nСоздавать структурированный JSON-отчет для каждого запуска функции `processMailbox`. Отчет должен содержать ключевую информацию о параметрах запуска, результатах обработки писем и ссылок, а также о возникших ошибках. Обеспечить возможность сохранения отчета в файл и/или отправки во внешнюю систему (например, Supabase).\n\n## Предлагаемая структура JSON-отчета\n\n```json\n{\n  \"runId\": \"уникальный_идентификатор_запуска\", \n  \"timestamp\": \"2023-10-27T10:30:00Z\",        // Время начала запуска (ISO 8601)\n  \"status\": \"success\" | \"partial_failure\" | \"failure\", // Общий статус выполнения\n  \"account\": \"user@example.com\",             // Аккаунт, который обрабатывался (параметр user)\n  \"sender\": \"from@example.com\",                // Адрес отправителя (параметр from)\n  \"emails\": {\n    \"found\": 50,                             // Сколько писем найдено\n    \"processed\": 48,                         // Сколько писем помечено как прочитанные (markAsSeen.length)\n    \"errors\": 2                              // Сколько ошибок возникло при обработке писем\n  },\n  \"links\": {\n    \"found\": 48,                             // Сколько ссылок было извлечено\n    \"targetOpen\": 34,                        // Сколько ссылок планировалось открыть (по openRate)\n    \"attemptedOpen\": 34,                     // Сколько ссылок фактически передано в openLinks\n    \"errors\": 1                              // Сколько ошибок возникло при открытии ссылок\n  },\n  \"errorMessages\": [                         // Массив строк с сообщениями об ошибках (опционально)\n    \"Ошибка обработки письма UID 12345: Timeout\",\n    \"Ошибка открытия ссылки https://example.com: Navigation failed\"\n  ]\n}\n```\n\n## Шаги по реализации\n\n1.  **Определить TypeScript Interface (`ProcessReport`):**\n    *   Создайте файл `backend/src/types/reports.ts` (или используйте существующий файл типов).\n    *   Опишите интерфейс `ProcessReport` в соответствии с предложенной структурой JSON.\n    ```typescript\n    // backend/src/types/reports.ts\n    export interface ProcessReport {\n      runId: string;\n      timestamp: string;\n      status: 'success' | 'partial_failure' | 'failure';\n      account: string;\n      sender: string;\n      emails: {\n        found: number;\n        processed: number;\n        errors: number;\n      };\n      links: {\n        found: number;\n        targetOpen: number;\n        attemptedOpen: number;\n        errors: number;\n      };\n      errorMessages?: string[];\n    }\n    ```\n\n2.  **Инициализировать объект отчета в `processMailbox`:**\n    *   Импортируйте `ProcessReport` и библиотеку для генерации ID (например, `uuid`). Установите: `npm install uuid @types/uuid`.\n    *   В начале `processMailbox` создайте и инициализируйте переменную `report`.\n    ```typescript\n    // backend/src/services/ProcessService/index.ts\n    import { v4 as uuidv4 } from 'uuid';\n    import { ProcessReport } from '../../types/reports';\n    import fs from 'fs'; // Добавить импорт fs для сохранения файла\n    import path from 'path'; // Добавить импорт path\n    // ... (остальные импорты)\n\n    export async function processMailbox({ /* ... параметры ... */ }) {\n      const report: ProcessReport = {\n        runId: uuidv4(),\n        timestamp: new Date().toISOString(),\n        status: 'failure', // Изменится в конце\n        account: user,\n        sender: from,\n        emails: { found: 0, processed: 0, errors: 0 },\n        links: { found: 0, targetOpen: 0, attemptedOpen: 0, errors: 0 },\n        errorMessages: []\n      };\n      // ... остальной код ...\n    }\n    ```\n\n3.  **Обновлять данные отчета во время выполнения `processMailbox`:**\n    *   После `searchUnseenFrom`: `report.emails.found = list.length;`\n    *   После расчета `shouldOpenCount`: `report.links.targetOpen = shouldOpenCount;`\n    *   В `catch` блоке цикла обработки `batch`:\n        *   `report.emails.errors++;`\n        *   `report.errorMessages?.push(\`Ошибка обработки письма ${message.uid}: ${err.message}\`);`\n    *   Когда `processEmail` вернул ссылку: `report.links.found++;`\n    *   Перед вызовом `openLinks`: `report.links.attemptedOpen = linksToOpen.length;`\n    *   В блоке `try` после `client.messageFlagsAdd`: `report.emails.processed = markAsSeen.length;` (или делать это в `finally`)\n\n4.  **Модифицировать `openLinks` для возврата ошибок:**\n    *   Измените сигнатуру `openLinks` в `backend/src/services/ProcessService/openLinks.ts`, чтобы она возвращала объект `{ errors: number; errorMessages: string[] }`.\n    *   Инициализируйте `errorCount = 0` и `errorMessages = []`.\n    *   В `catch` блоке внутри цикла `for` увеличивайте `errorCount` и добавляйте сообщение в `errorMessages`.\n    *   Верните `{ errors: errorCount, errorMessages: errorMessages }` в конце функции.\n    ```typescript\n    // backend/src/services/ProcessService/openLinks.ts\n    export const openLinks = async (links: string[]): Promise<{ errors: number; errorMessages: string[] }> => {\n      // ... browser launch ...\n      let errorCount = 0;\n      const errorMessages: string[] = [];\n      try {\n        for (const link of links) {\n          // ... page creation ...\n          try {\n             // ... page.goto ...\n          } catch (err: any) {\n            console.error(`Error processing link ${link}:`, err);\n            errorCount++;\n            errorMessages.push(`Ошибка открытия ${link}: ${err.message || 'Unknown error'}`);\n          } finally {\n             // ... page.close ...\n          }\n        }\n      } finally {\n         // ... browser.close ...\n      }\n      return { errors: errorCount, errorMessages: errorMessages };\n    };\n    ```\n\n5.  **Сохранить ошибки из `openLinks` в отчете `processMailbox`:**\n    *   После вызова `await openLinks(linksToOpen);`:\n    ```typescript\n    if (linksToOpen.length) {\n        const openResult = await openLinks(linksToOpen);\n        report.links.errors = openResult.errors;\n        if (openResult.errorMessages.length > 0 && report.errorMessages) {\n          report.errorMessages.push(...openResult.errorMessages);\n        }\n    }\n    ```\n\n6.  **Определить финальный статус и вывести/сохранить отчет:**\n    *   В `finally` блоке `processMailbox`:\n        *   Определите `report.status`:\n          ```typescript\n          if (report.emails.errors === 0 && report.links.errors === 0) {\n            report.status = 'success';\n          } else {\n            // Можно добавить более сложную логику для partial_failure\n            report.status = 'partial_failure'; \n          }\n          // Если сработал внешний catch, статус останется 'failure'\n          ```\n        *   **Вывод в консоль:**\n          `console.log(\"Process Report:\", JSON.stringify(report, null, 2));`\n        *   **(Опционально) Сохранение в файл:**\n          ```typescript\n          try {\n            const reportDir = path.join(__dirname, '..', '..', 'reports');\n            if (!fs.existsSync(reportDir)) {\n              fs.mkdirSync(reportDir, { recursive: true });\n            }\n            const reportPath = path.join(reportDir, `report-${report.runId}.json`);\n            fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));\n            console.log(`Отчет сохранен: ${reportPath}`);\n          } catch (writeErr) {\n            console.error(\"Ошибка сохранения отчета:\", writeErr);\n          }\n          ```\n        *   **(Опционально) Отправка в Supabase:**\n            *   `npm install @supabase/supabase-js`\n            *   Настройте и импортируйте клиент Supabase.\n            *   Используйте `await supabase.from('имя_таблицы').insert([report]);`.\n            ```typescript\n            // try {\n            //    const { error } = await supabase.from('process_reports').insert([report]);\n            //    if (error) throw error;\n            //    console.log(`Отчет ${report.runId} отправлен в Supabase`);\n            // } catch (supabaseError) {\n            //   console.error(\"Ошибка отправки отчета в Supabase:\", supabaseError);\n            // }\n            ```\n\n## Следующие шаги\n\n1.  Создать файл `backend/src/types/reports.ts` и определить интерфейс `ProcessReport`.\n2.  Установить `uuid`: `npm install uuid @types/uuid`.\n3.  Внедрить логику сбора данных и формирования отчета в `processMailbox`.\n4.  Модифицировать `openLinks` для возврата информации об ошибках.\n5.  Реализовать сохранение/отправку отчета в `finally` блоке `processMailbox`.\n6.  При необходимости настроить интеграцию с Supabase (создать таблицу, настроить клиент).
